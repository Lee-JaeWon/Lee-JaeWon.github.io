---
title : "Lec 10-4: Custom Dataset - ImageFolder"
category :
    - Deep_Learning_Study
tag :
    - Deep_Learning
    - Boost Course
toc : true
toc_sticky: true
comments: true
---

Deep_Learning study Lec10-4

## Boostcourseì˜ 'íŒŒì´í† ì¹˜ë¡œ ì‹œì‘í•˜ëŠ” ë”¥ëŸ¬ë‹ ê¸°ì´ˆ'ë¥¼ í†µí•œ ê³µë¶€ì™€ ì •ë¦¬ Post    

## Goal of Study  
> - ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³¸ë‹¤. 

### Keyword
> - Image Folder    
> - CNN  
    
## 1. ê°•ì˜ ìš”ì•½  
### ImageFolder
ì´ì œ ì‚¬ìš©ìê°€ í•™ìŠµí•˜ê³ ì í•˜ëŠ” ë°ì´í„°ë¥¼ ì§ì ‘ ê°€ì ¸ì™€ í•™ìŠµì‹œì¼œë³´ëŠ” ê³¼ì •ì´ë‹¤.

í•„ìëŠ” kaggleì´ë¼ëŠ” ì‚¬ì´íŠ¸ì—ì„œ ê³ ì–‘ì´ì™€ ê°œì˜ ì‚¬ì§„ì„ ê°ê° 12500ì¥ì”© ê°€ì ¸ì™€ í•™ìŠµì‹œí‚¬ ì˜ˆì •ì´ë‹¤.

<p align="center"><img src="https://user-images.githubusercontent.com/72693388/128033740-7938b006-2a2c-4810-906e-22de72690239.png" width = "300" ></p>
ë‹¤ìš´ë°›ì•„ì˜¤ê±°ë‚˜ í•™ìŠµì‹œí‚¤ê³  ì‹¶ì€ ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ë‹¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ í´ë”ë¥¼ êµ¬ì„±í•´ì¤„ê²ƒì´ë‹¤.

ìœ„ì²˜ëŸ¼, íŒŒì¼ì„ êµ¬ì„±í•´ì£¼ì—ˆë‹¤.
<p align="center"><img src="https://user-images.githubusercontent.com/72693388/128033545-4bbe02b9-89e0-40b2-b686-363a908a8070.png" width = "500" ></p>

ì´ì œ, ì´ ë°ì´í„°ë“¤ì˜ ì‚¬ì´ì¦ˆë¥¼ ê°™ì€ ì‚¬ì´ì¦ˆë¡œ ë§ì¶°ì¤„ ê²ƒì´ë‹¤.  
(ì‚¬ì´ì¦ˆê°€ ë„ˆë¬´ í¬ê±°ë‚˜, ë™ì¼í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì—)

```python
import torchvision
from torchvision import transforms

from torch.utils.data import DataLoader
```
```python
from matplotlib.pyplot import imshow
%matplotlib inline
```
```python
trans = transforms.Compose([
    transforms.Resize((64,128))
])

train_data = torchvision.datasets.ImageFolder(root='E:/DeepLearningStudy/custom_data/origin_data', transform=trans)
```
ë‹¤ìŒê³¼ ê°™ì´ train_dataë¥¼ ë§Œë“¤ì–´ ì¤„ ê²ƒì´ë‹¤.  

`torchvision.datasets.MNIST`ë“±ì„ ì‚¬ìš©í–ˆì—ˆëŠ”ë° ì—¬ê¸°ì„œëŠ” ì»¤ìŠ¤í…€ ë°ì´í„°ë¥¼ ìœ„í•´ `.ImageFolder`ë¥¼ ì‚¬ìš©í•´ ì¤„ ê²ƒì´ë‹¤.

ê²½ë¡œë¥¼ ì§€ì •í•´ì£¼ê³ , transformì„ ìœ„ì—ì„œ ì§€ì •í•œ trasë¥¼ í†µí•´ 64 by 128 ì‚¬ì´ì¦ˆë¡œ `Resize`í•´ì¤€ë‹¤.  
```python
for num, value in enumerate(train_data):
    data, label = value
    print(num, data, label)
    
    if(label == 0):
        data.save('E:/DeepLearningStudy/custom_data/train_data/cat/%d_%d.jpeg'%(num, label))
    else:
        data.save('E:/DeepLearningStudy/custom_data/train_data/dog/%d_%d.jpeg'%(num, label))
```
ì´ë¥¼ ë§¤ë²ˆ Resizeí•  ìˆ˜ëŠ” ì—†ê¸°ì— `data.save`ë¥¼ í†µí•´ train_data/cat(or dog) ê²½ë¡œì— resizeí•œ ì‚¬ì§„ë“¤ì„ ì €ì¥í•´ì¤€ë‹¤.  
(ì‹¤í–‰ì „, ì € ê²½ë¡œì— ë™ì¼í•œ ë¹ˆ í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•´ì•¼í•œë‹¤.)

ê·¸ëŸ¬ë©´ 25000ì¥ì˜ ì‚¬ì§„ì´ ëª¨ë‘ ë³€í™˜ë˜ì–´ train_data/ ê²½ë¡œì— ì €ì¥ëœë‹¤.
<p align="center"><img src="https://user-images.githubusercontent.com/72693388/128037844-9cb9ee6f-3035-48fa-9e06-0d4acd937293.png" width = "600" ></p>
<p align="center"><img src="https://user-images.githubusercontent.com/72693388/128037978-ac240d9d-01a6-4732-9c49-107372b707c0.png" width = "600" ></p>
<p align="center"><img src="https://user-images.githubusercontent.com/72693388/128038061-34cd8c82-5f05-48d6-9496-0e9600d6cda3.png" width = "400" ></p>

### ì‹¤ì œ í•™ìŠµ
<p align="center"><img src="https://user-images.githubusercontent.com/72693388/128038906-87ac8312-b402-4d78-b271-6ebb89913f69.png" width = "400" ></p>

ì´ì „ì²˜ëŸ¼, ë‹¤ìŒê³¼ ê°™ì€ ê³¼ì •ì„ í†µí•´ í•™ìŠµì„ ì§„í–‰í•  ê²ƒì´ë‹¤.

<p align="center"><img src="https://user-images.githubusercontent.com/72693388/128039045-60b5452c-752b-4867-8fd6-e44229510b6c.png" width = "400" ></p>
ê° ë ˆì´ì–´ì˜ êµ¬ì„±ì€ ìœ„ì™€ ê°™ë‹¤.

RGBì´ê¸° ë•Œë¬¸ì— input_channelì€ 3ì±„ë„ì´ê³ , ì»¤ë„ ì‚¬ì´ì¦ˆëŠ” 5, paddingì€ ì—†ë‹¤.

ì´ë¥¼ 6ì±„ë„ë¡œ ê·¸ë¦¬ê³  16ì±„ë„ë¡œ ì¶œë ¥í•¨ìœ¼ë¡œì¨, ìœ„ì˜ ë‘ Layerë¥¼ í†µí•´ 64 by 128ì˜ ì´ë¯¸ì§€ëŠ”

16ì±„ë„ì˜ 13 by 29ì˜ ì´ë¯¸ì§€ê°€ ëœë‹¤.

ê³„ì‚°ê³¼ì •ì€ [ì´ì „ í¬ìŠ¤íŒ…](https://lee-jaewon.github.io/deep_learning_study/Lec10-1/#%EC%9E%85%EB%A0%A5%EC%9D%98-%ED%98%95%ED%83%9C-%EC%B6%9C%EB%A0%A5%EC%9D%98-%ED%81%AC%EA%B8%B0)ì—ì„œ ë‹¤ë£¨ì—ˆì—ˆë‹¤.  
<p align="center"><img src="https://user-images.githubusercontent.com/72693388/127730753-bc880f45-3033-4a96-bffb-5f526b6dc1e5.png" width = "500" ></p>

ìœ„ì™€ ê°™ì´ ê³„ì‚°í•´ì¤€í›„, Max Pooling(2)ë¥¼ ì§„í–‰í•´ì£¼ë©´ 13 by 29ê°€ ë‚˜ì˜¤ëŠ” ê²ƒì„ í™•ì¸í•´ë³´ë©´ ì¢‹ì„ ê²ƒê°™ë‹¤.

ì´ë¥¼ `.view`ë¥¼ í†µí•´ í•œ ì°¨ì›ìœ¼ë¡œ í¼ì³ì£¼ë©´, 6032ë¡œ ë‚˜ì˜¨ë‹¤.

ì´ì œ Fully connected layerë¥¼ í†µí•´ 6032ì—ì„œ 120ìœ¼ë¡œ 120ì—ì„œ 2ë¡œ ì¶œë ¥í•´ë‚¼ ê²ƒì´ë‹¤.

#### Code
```python
import torch
import torch.nn as nn
import torch.nn.functional as F

import torch.optim as optim
from torch.utils.data import DataLoader

import torchvision
import torchvision.transforms as transforms

from matplotlib.pyplot import imshow
%matplotlib inline
```
```python
device = 'cuda' if torch.cuda.is_available() else 'cpu'
print("ë‹¤ìŒ ê¸°ê¸°ë¡œ í•™ìŠµí•©ë‹ˆë‹¤:", device)

torch.manual_seed(777)
if device =='cuda':
    torch.cuda.manual_seed_all(777)
```
```python
trans = transforms.Compose([
    transforms.ToTensor()
])

train_data = torchvision.datasets.ImageFolder(root='E:/DeepLearningStudy/custom_data/train_data', transform=trans)
```
ìœ„ì˜ ì½”ë“œì™€ ë‹¬ë¼ì§„ ì ì€ ì´ì œ input shapeì„ Tensorë¡œ ë„£ì–´ì¤˜ì•¼í•˜ê¸° ë•Œë¬¸ì—

`.ToTensor()`ë¥¼ ì‚¬ìš©í•´ì£¼ì—ˆë‹¤. ê·¸ë¦¬ê³  ë°”ë¡œ ì•„ë˜ì˜ ì½”ë“œë¥¼ í†µí•´ êµ¬ì„±í•´ì˜€ë˜ Train_dataë¡œ ê²½ë¡œë¥¼ ì§€ì •í•´ì£¼ì—ˆë‹¤.
```python
for num, value in enumerate(train_data):
    data, label = value
    print(num, data, label)
    
    if(label == 0):
        data.save('E:/DeepLearningStudy/custom_data/train_data/cat/%d_%d.jpeg'%(num, label))
    else:
        data.save('E:/DeepLearningStudy/custom_data/train_data/dog/%d_%d.jpeg'%(num, label))
```
ì´ ê³¼ì •ì„ ì´ë¯¸ ìˆ˜í–‰í•˜ì˜€ë‹¤ë©´ ë°ì´í„°ê°€ í´ë”ì— ì €ì¥ë˜ì—ˆê¸° ë•Œë¬¸ì— êµ³ì´ ë˜ ì‹¤í–‰ì‹œí‚¤ì§€ ì•Šì•„ë„ ëœë‹¤.

```python
data_loader = DataLoader(dataset = train_data, batch_size = 8, shuffle = True, num_workers=2)
```
ì´ë¥¼, dataloaderë¡œ ë¶ˆëŸ¬ì„œ ì‚¬ìš©í•  ê²ƒì´ë‹¤.

`num_workers`ëŠ” ì²˜ìŒë³´ëŠ” ê²ƒê°™ì•„ [Pytorch_Documents](https://pytorch.org/docs/stable/data.html#torch.utils.data.DataLoader)ì—ì„œ DataLoaderì— ê´€í•œ ë¶€ë¶„ì„ ì°¾ì•„ë³´ì•˜ë‹¤.

> num_workers (int, optional) â€“ how many subprocesses to use for data loading. 0 means that the data will be loaded in the main process. (default: 0)

ì´ ë§¤ê°œë³€ìˆ˜ì— ëŒ€í•œ ê³ ì°°ì„ ë‹¤ë¥¸ ë¶„ì´ ì˜ í¬ìŠ¤íŒ…ì„ í•´ë†“ìœ¼ì…”ì„œ ì°¸ê³ í•˜ì˜€ë‹¤.  
[DataLoader_num_workersì— ëŒ€í•œ ê³ ì°°](https://jybaek.tistory.com/799)

ê°„ë‹¨íˆ ì´í•´í•œë°”ë¡œëŠ” CPUì™€ GPUê°„ì˜ taskë¶„ë‹´ê³¼ CPUì—ì„œ Nê°œì˜ ì½”ì–´ë¡œ Data Loadë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì§€ì •í•´ì£¼ëŠ” parameterê°€ num_workers ì´ë©°,

ì´ paramì˜ íŠœë‹ì„ ìœ„í•´ ê³ ë ¤í•´ì•¼ í•˜ëŠ” ë¶€ë¶„ì´ ë§ì•„ì„œ(CPU, GPU, ë©”ëª¨ë¦¬, I/Oì†ë„) ì´ ê°’ íŠœë‹ì— ëŒ€í•œ ì´ìŠˆë“¤ ë˜í•œ ë§ì´ í† ë¡ í•œë‹¤ê³  í•œë‹¤.

```python
class CNN(nn.Module):
    def __init__(self):
        super(CNN, self).__init__()
        self.layer1 = nn.Sequential(
            #input channel = 3, output channel = 6, Kernel size = 5, stride = 1, padding = 0
            nn.Conv2d(3,6,5),
            nn.ReLU(),
            nn.MaxPool2d(2),
        )
        self.layer2 = nn.Sequential(
            nn.Conv2d(6,16,5),
            nn.ReLU(),
            nn.MaxPool2d(2),
        )
        self.layer3 = nn.Sequential(
            nn.Linear(16*13*29, 120),
            nn.ReLU(),
            nn.Linear(120,2)
        )
        
    def forward(self, x):
        out = self.layer1(x)
        out = self.layer2(out)
        out = out.view(out.shape[0], -1)
        out = self.layer3(out)
        return out
```
ê·¸ë¦¬ê³  ìœ„ì˜ Layer êµ¬ì„± ì„¤ëª…ì— ë”°ë¼ ë‹¤ìŒê³¼ ê°™ì´ CNN()ì„ êµ¬ì„±í•´ì¤€ë‹¤.
```python
net = CNN().to(device)
test_input = (torch.Tensor(3,3,64,128)).to(device)
test_out = net(test_input)
```
>torch.Size([3, 6, 30, 62])  
torch.Size([3, 16, 13, 29])  
torch.Size([3, 6032])  

ê·¸ë¦¬ê³  modelì„ ë§Œë“¤ì–´ì¤€ë‹¤.(net)

```python
optimizer = optim.Adam(net.parameters(), lr=0.00005)
loss_func = nn.CrossEntropyLoss().to(device)
```
```python
total_batch = len(data_loader)

epochs = 5
for epoch in range(epochs):
    avg_cost = 0.0
    for num, data in enumerate(data_loader):
        imgs, labels = data

        imgs = imgs.to(device)
        labels = labels.to(device)

        optimizer.zero_grad()
        out = net(imgs)

        loss = loss_func(out, labels)
        loss.backward()
        optimizer.step()
        
        avg_cost += loss / total_batch
        
    print('[Epoch:{}] cost = {}'.format(epoch+1, avg_cost))
print('Learning Finished!')
```
ê·¸ë¦¬ê³  í•™ìŠµì„ ì‹œì¼œì¤€ë‹¤.

> [Epoch:5] cost = 0.5111982822418213  
Learning Finished!

#### model save
```python
torch.save(net.state_dict(), "E:/DeepLearningStudy/custom_data/model/model.pth")
```
```python
new_net = CNN().to(device)
```
```python
new_net.load_state_dict(torch.load('E:/DeepLearningStudy/custom_data/model/model.pth'))
```
```python
# í™•ì¸ ê³¼ì •
print(net.layer1[0])
print(new_net.layer1[0])

print(net.layer1[0].weight[0][0][0])
print(new_net.layer1[0].weight[0][0][0])

net.layer1[0].weight[0] == new_net.layer1[0].weight[0]
```
> 
Conv2d(3, 6, kernel_size=(5, 5), stride=(1, 1))  
Conv2d(3, 6, kernel_size=(5, 5), stride=(1, 1))  
tensor([ 0.0225,  0.1049,  0.0722, -0.0684, -0.0265], grad_fn=<SelectBackward>)  
tensor([ 0.0225,  0.1049,  0.0722, -0.0684, -0.0265], grad_fn=<SelectBackward>)
>
Out : tensor([[[True, True, True, True, True],  
         [True, True, True, True, True],  
         [True, True, True, True, True],  
         [True, True, True, True, True],  
         [True, True, True, True, True]],  

        [[True, True, True, True, True],  
         [True, True, True, True, True],  
         [True, True, True, True, True],  
         [True, True, True, True, True],  
         [True, True, True, True, True]],  

        [[True, True, True, True, True],  
         [True, True, True, True, True],  
         [True, True, True, True, True],  
         [True, True, True, True, True],  
         [True, True, True, True, True]]])  

ìœ„ì˜ ê³¼ì •ì€ í•™ìŠµì‹œí‚¨ ëª¨ë¸ì„ saveí•´ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ê³¼ì •ì´ë‹¤.

ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•´ì„œëŠ” ëª¨ë¸ì˜ ëª¨ì–‘ì´ ê°™ì•„ì•¼í•œë‹¤.

### Test  
```python
trans=torchvision.transforms.Compose([
    transforms.Resize((64,128)),
    transforms.ToTensor()
])
test_data = torchvision.datasets.ImageFolder(root='E:/DeepLearningStudy/custom_data/test_data/', transform=trans)
```
```python
test_set = DataLoader(dataset = test_data, batch_size = len(test_data))
```
kaggleì—ì„œ ë°ì´í„°ë¥¼ ë‹¤ìš´ë°›ì„ë•Œ Test setë„ ì œê³µì„ í•´ì¤˜ì„œ ìœ„ì™€ ê°™ì´ ê²½ë¡œë¥¼ ì„¤ì •í•´ì£¼ê³  Testë¥¼ ì§„í–‰í•˜ì˜€ë‹¤.

ì£¼ì˜ì ì€ test_data/ ì•ˆì˜ testí´ë”(ì˜ˆì‹œ) ì•ˆì— ì‚¬ì§„ì´ ìˆì–´ì•¼í•œë‹¤.

ê·¸ëƒ¥ test_data/ ì•ˆì— ë°”ë¡œ ì‚¬ì§„ë“¤ì´ ë“¤ì–´ìˆë‹¤ë©´, ê·¸ ê²½ë¡œì•ˆì— ì–´ë– í•œ classë„ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì—ëŸ¬ê°€ ëœ¬ë‹¤.

```python
with torch.no_grad():
    for num, data in enumerate(test_set):
        imgs, label = data
        imgs = imgs.to(device)
        label = label.to(device)
        
        prediction = net(imgs)
        
        correct_prediction = torch.argmax(prediction, 1) == label
        
        accuracy = correct_prediction.float().mean()
        print('Accuracy:', accuracy.item())
```
>
torch.Size([12500, 6, 30, 62])  
torch.Size([12500, 16, 13, 29])  
torch.Size([12500, 6032])  
Accuracy: 0.5333600044250488  

---
í•™ìŠµê²°ê³¼ Accuracyê°€ ë‚®ì•„ì„œ epoch(5->10)ì„ ëŠ˜ë ¤ì„œ ë‹¤ì‹œ í•™ìŠµì‹œì¼œë´¤ë‹¤.
Learning rateë„ 0.0001ë¡œ ì‹¤í–‰í•´ë³´ì•˜ë‹¤.

> (epoch 10, lr = 0.00005)  
[Epoch:10] cost = 0.37749120593070984  
Learning Finished!  
Accuracy: 0.5279200077056885

> (epoch 10, lr = 0.0001)  
[Epoch:10] cost = 0.13914641737937927  
Learning Finished!  
Accuracy: 0.5212799906730652

Costê°€ ê°ì†Œí•˜ëŠ” ê²ƒì— ë¹„í•´ ì •í™•ë„ê°€ ì˜ ë‚˜ì˜¤ì§€ ì•ŠëŠ”ë‹¤.

### ë§ˆë¬´ë¦¬
ë³¸ í¬ìŠ¤íŒ…ì—ì„œëŠ” ì‚¬ìš©ìì˜ Dataë¥¼ ê°€ì§€ê³ , Data-setë¥¼ êµ¬ì„±í•˜ê³ ,

ì´ë¥¼ ì ì ˆí•œ ì‚¬ì´ì¦ˆë¡œ ë³€í™˜ì‹œí‚¨ í›„, ë™ì¼í•˜ê²Œ CNN í•™ìŠµì„ ì§„í–‰í•˜ì˜€ë‹¤.

ìœ„ì— ëŒ€í•œ ì „ì²´ ì½”ë“œëŠ” [Github_custom data]()ì— ì˜¬ë ¤ë†“ì•˜ë‹¤.

ğŸ“£<br>
ë³¸ í¬ìŠ¤íŒ…ì˜ í•™ìŠµ í™˜ê²½ : `Anaconda`, `CPU`, `Pytorch`, `Jupyter Notebook`  
í¬ìŠ¤íŒ…ì—ì„œ ì˜¤ë¥˜ë‚˜ ê¶ê¸ˆí•œ ì ì€ Commentsë¥¼ ì‘ì„±í•´ì£¼ì‹œë©´, ë§ì€ ë„ì›€ì´ ë©ë‹ˆë‹¤.ğŸ’¡  
{: .notice--info}